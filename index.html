<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TaylorMade Match Play ‚Äì Tournament Tracker</title>
  <style>
    :root{
      --bg: #0b1220;
      --card: #10192b;
      --muted: #8aa0c6;
      --text: #e8f0ff;
      --accent: #4dd0e1;
      --accent-2: #7c4dff;
      --win: #2ecc71;
      --lose: #e74c3c;
      --warn: #ffb020;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background: radial-gradient(1000px 600px at 10% -10%, #152647, transparent),
                  radial-gradient(900px 500px at 110% -20%, #371a57, transparent),
                  linear-gradient(180deg, #080c17, #0b1220);
      background-attachment: fixed;
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: linear-gradient(180deg, rgba(11,18,32,.9), rgba(11,18,32,.5));
      border-bottom: 1px solid rgba(255,255,255,.06);
    }
    .wrap{max-width:1200px; margin:0 auto; padding: 16px;}
    .topbar{display:flex; align-items:center; gap:16px;}
    .brand{
      display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:.3px;
    }
    .logo{width:36px; height:36px; border-radius:8px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); box-shadow: var(--shadow)}
    .subtitle{color:var(--muted); font-size:.95rem}
    .tabs{margin-left:auto; display:flex; gap:8px}
    .tab{appearance:none; border:1px solid rgba(255,255,255,.1); background:transparent; color:var(--text); padding:8px 14px; border-radius:10px; cursor:pointer}
    .tab.active{background: linear-gradient(135deg, rgba(77,208,225,.18), rgba(124,77,255,.18)); border-color: transparent}

    .notice{background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); padding:10px 12px; border-radius:10px; color:var(--muted); font-size:.9rem}

    main{padding: 20px 0 80px}
    h2{margin: 18px 6px 10px; font-size:1.1rem; color:#bcd1ff; letter-spacing:.2px}

    .grid{display:grid; grid-template-columns: repeat(auto-fit, minmax(270px, 1fr)); gap:12px}
    .card{background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:14px; box-shadow: var(--shadow)}
    .match{
      display:flex; flex-direction:column; gap:10px;
    }
    .row{display:flex; justify-content:space-between; align-items:center; gap:10px}
    .players{display:flex; flex-direction:column; gap:6px}
    .p{display:flex; align-items:center; gap:8px}
    .name{font-weight:600}
    .hcp{color:var(--muted); font-size:.85rem}
    .badge{font-size:.72rem; padding:2px 8px; border-radius:999px; border:1px solid rgba(255,255,255,.1); color:#bcd1ff}

    .result{display:flex; align-items:center; gap:8px}
    .result .win{color:var(--win); font-weight:700}
    .result .lose{color:var(--lose);}

    .btn{appearance:none; background: linear-gradient(135deg, rgba(77,208,225,.15), rgba(124,77,255,.15)); color:var(--text); border:1px solid rgba(255,255,255,.08); padding:8px 12px; border-radius:12px; cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .btn.small{padding:6px 10px; font-size:.9rem}
    .btn.ghost{background: transparent}

    .kicker{font-size:.85rem; color:var(--muted)}

    .standings{display:grid; grid-template-columns: repeat(auto-fit, minmax(320px,1fr)); gap:16px}
    .table{width:100%; border-collapse: collapse}
    .table th, .table td{padding:8px 6px; border-bottom: 1px dashed rgba(255,255,255,.08)}
    .table th{font-weight:600; color:#c7d6ff; text-align:left}
    .table td.stat{text-align:center}
    .qual{background: linear-gradient(135deg, rgba(46,204,113,.15), rgba(46,204,113,.08)); border:1px solid rgba(46,204,113,.25)}

    /* modal */
    dialog{border:none; border-radius:16px; padding:0; background: rgba(22,28,44,.98); color:var(--text); width:min(92vw, 520px); box-shadow: var(--shadow)}
    .modal-header{padding:16px 18px; border-bottom:1px solid rgba(255,255,255,.08); display:flex; justify-content:space-between; align-items:center}
    .modal-body{padding:18px; display:flex; flex-direction:column; gap:12px}
    .modal-actions{padding:16px 18px; display:flex; justify-content:flex-end; gap:10px; border-top:1px solid rgba(255,255,255,.08)}
    select, .select{width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.15); background:#0d1526; color:var(--text)}
    .two-col{display:grid; grid-template-columns:1fr 1fr; gap:10px}

    footer{position:fixed; bottom:10px; right:10px; display:flex; gap:8px}
    .pill{font-size:.8rem; color:var(--muted)}

    @media (max-width:600px){
      .row.wrap{flex-direction:column; align-items:flex-start}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="topbar">
        <div class="logo" aria-hidden="true"></div>
        <div class="brand">
          <div>
            <div style="font-size:1.1rem; line-height:1.2">TaylorMade Match Play ‚Äì Tournament Tracker</div>
            <div class="subtitle">Stage 1 ¬∑ Group Play ¬∑ Sept 22 ‚Äì Oct 11 ¬∑ 9-hole match play (Front 9)</div>
          </div>
        </div>
        <div class="tabs">
          <button id="tabMatches" class="tab active" onclick="switchView('matches')">Matches</button>
          <button id="tabStandings" class="tab" onclick="switchView('standings')">Standings</button>
        </div>
      </div>
      <div class="notice" id="initNotice" style="display:none; margin-top:10px"></div>
    </div>
  </header>

  <main class="wrap">
    <section id="viewMatches">
      <div id="matchesContainer"></div>
    </section>
    <section id="viewStandings" style="display:none">
      <div id="standingsContainer"></div>
    </section>
  </main>

  <dialog id="resultDialog">
    <div class="modal-header">
      <div>
        <div style="font-weight:700">Record Match Result</div>
        <div id="modalMatchLabel" class="kicker"></div>
      </div>
      <button class="btn ghost small" onclick="closeDialog()">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="two-col">
        <div>
          <label class="kicker">Winner</label>
          <select id="winnerSelect" class="select"></select>
        </div>
        <div>
          <label class="kicker">Victory Margin</label>
          <select id="marginSelect" class="select"></select>
        </div>
      </div>
      <div class="kicker">Anyone can record results. Updates appear in real-time for everyone.</div>
    </div>
    <div class="modal-actions">
      <button class="btn ghost" onclick="closeDialog()">Cancel</button>
      <button class="btn" id="saveResultBtn">Save Result</button>
    </div>
  </dialog>

  <footer>
    <button class="btn small" id="exportBtn" title="Download current data as JSON">üì• Export</button>
    <button class="btn small" id="resetBtn" style="display:none" title="Reset (wipe DB and re-seed)">‚ôªÔ∏è Reset</button>
  </footer>

  <script>
    // ====== CONFIG (no SDKs; pure REST so it works on GitHub Pages) ======
    const DB_URL = 'https://taylormadegolf-default-rtdb.firebaseio.com';
    const ROOT_PATH = '/tournament';

    // If you need to exclude Ali vs Konda in Group D before seeding for the first time,
    // toggle the flag below to true, then click the Reset button (add #admin to URL to show it).
    const EXCLUDE_ALI_VS_KONDA = false;

    // ====== STATE ======
    let appState = { players:{}, matches:{}, meta:{} };
    let selectedMatchId = null;
    const clientId = (() => {
      const k = 'tm_matchplay_uid';
      let v = localStorage.getItem(k);
      if(!v){ v = 'u_' + Math.random().toString(36).slice(2,10); localStorage.setItem(k,v); }
      return v;
    })();

    // ====== UTIL ======
    async function api(path, {method='GET', body=null}={}){
      const url = `${DB_URL}${path}.json`;
      const opts = { method, headers:{ 'Content-Type':'application/json' } };
      if(body!==null) opts.body = JSON.stringify(body);
      const res = await fetch(url, opts);
      if(!res.ok) throw new Error('HTTP '+res.status);
      return await res.json();
    }
    async function apiDelete(path){
      const url = `${DB_URL}${path}.json`;
      const res = await fetch(url, { method:'DELETE' });
      if(!res.ok) throw new Error('HTTP '+res.status);
      return await res.json();
    }

    function onStream(path, handler){
      const url = `${DB_URL}${path}.json`;
      const es = new EventSource(url);
      es.addEventListener('put', (e)=>{ try{ handler(JSON.parse(e.data)); }catch{} });
      es.addEventListener('patch', (e)=>{ try{ handler(JSON.parse(e.data)); }catch{} });
      es.onerror = (e)=>{ console.warn('Stream error (auto-retrying)...', e); };
      return es;
    }

    function byGroup(players){
      const g = { A:[], B:[], C:[], D:[] };
      for(const p of Object.values(players)) g[p.group].push(p);
      return g;
    }

    function makeId(prefix='m'){
      return prefix + '_' + Math.random().toString(36).slice(2,9);
    }

    function marginToDiff(m){
      if(!m) return 0;
      if(m === '1 up') return 1;
      const parts = m.split('&')[0].trim();
      const n = parseInt(parts,10); return isNaN(n)?0:n;
    }

    function formatName(p){ return `${p.name} <span class="hcp">(${p.hcp})</span>`; }

    // ====== SEED DATA (runs once if DB empty) ======
    function seedPlayers(){
      const players = {};
      // Group A
      players['a1'] = { id:'a1', name:'Craig Schneider', hcp:2.6, group:'A' };
      players['a2'] = { id:'a2', name:'Buddha Gurung', hcp:8.5, group:'A' };
      players['a3'] = { id:'a3', name:'Mike Callagy', hcp:11.0, group:'A' };
      players['a4'] = { id:'a4', name:'Cesar Zepeda', hcp:20.1, group:'A' };
      // Group B
      players['b1'] = { id:'b1', name:'Elliot Badar', hcp:6.2, group:'B' };
      players['b2'] = { id:'b2', name:'Tom Collard', hcp:7.5, group:'B' };
      players['b3'] = { id:'b3', name:'Sree Gottipati', hcp:12.0, group:'B' };
      players['b4'] = { id:'b4', name:'Brian Crumrine', hcp:17.5, group:'B' };
      // Group C
      players['c1'] = { id:'c1', name:'Nathan Kelly', hcp:7.0, group:'C' };
      players['c2'] = { id:'c2', name:'Rick Lines', hcp:8.0, group:'C' };
      players['c3'] = { id:'c3', name:'David Damitz', hcp:9.3, group:'C' };
      players['c4'] = { id:'c4', name:'Paul Wollenburg', hcp:9.5, group:'C' };
      // Group D (5 players)
      players['d1'] = { id:'d1', name:'Quyen Dang', hcp:8.3, group:'D' };
      players['d2'] = { id:'d2', name:'Abram Rios', hcp:7.0, group:'D' };
      players['d3'] = { id:'d3', name:'Keshav Prasad', hcp:8.0, group:'D' };
      players['d4'] = { id:'d4', name:'Ali Chitsaz', hcp:8.5, group:'D' };
      players['d5'] = { id:'d5', name:'Konda Reddy Polu', hcp:12.0, group:'D' };
      return players;
    }

    function roundRobinPairs(ids){
      const pairs=[]; for(let i=0;i<ids.length;i++){ for(let j=i+1;j<ids.length;j++){ pairs.push([ids[i], ids[j]]); } } return pairs;
    }

    function seedMatches(players){
      const groups = byGroup(players);
      const matches = {};
      function addMatch(group, p1, p2){
        const id = makeId('m');
        matches[id] = { id, group, p1, p2, stage:'Group', result:null };
      }
      // A, B, C: 4-player round robin (6 matches each group)
      for(const g of ['A','B','C']){
        const ids = groups[g].map(p=>p.id);
        for(const [x,y] of roundRobinPairs(ids)) addMatch(g, x, y);
      }
      // D: 5-player round robin (10 matches). Optionally exclude Ali vs Konda.
      {
        const ids = groups['D'].map(p=>p.id);
        let pairs = roundRobinPairs(ids);
        if(EXCLUDE_ALI_VS_KONDA){
          pairs = pairs.filter(([x,y])=> !( (x==='d4' && y==='d5') || (x==='d5' && y==='d4') ));
        }
        for(const [x,y] of pairs) addMatch('D', x, y);
      }
      return matches;
    }

    async function ensureSeeded(){
      try{
        const meta = await api(`${ROOT_PATH}/meta`);
        if(meta && meta.initialized){
          return; // already seeded
        }
        const players = seedPlayers();
        const matches = seedMatches(players);
        const payload = { players, matches, meta:{ initialized: true, initializedAt: Date.now(), excludeAliVsKonda: !!EXCLUDE_ALI_VS_KONDA } };
        await api(`${ROOT_PATH}`, { method:'PUT', body: payload });
        showInitNotice('Tournament data initialized. You are good to go.');
      }catch(err){ console.error('Seed failed', err); }
    }

    // ====== RENDER ======
    function el(html){ const d=document.createElement('div'); d.innerHTML=html.trim(); return d.firstElementChild; }

    function renderMatches(){
      const container = document.getElementById('matchesContainer');
      const groups = { A:[], B:[], C:[], D:[] };
      const byId = appState.matches;
      const entries = Object.values(byId).sort((a,b)=> a.group.localeCompare(b.group));
      for(const m of entries){ groups[m.group].push(m); }
      container.innerHTML = '';
      for(const g of ['A','B','C','D']){
        const section = el(`<div><h2>Group ${g} <span class="kicker">${(appState.meta.excludeAliVsKonda && g==='D')? '¬∑ Ali vs Konda not scheduled' : ''}</span></h2><div class="grid" id="grid_${g}"></div></div>`);
        container.appendChild(section);
        const grid = section.querySelector(`#grid_${g}`);
        for(const m of groups[g]){
          const p1 = appState.players[m.p1];
          const p2 = appState.players[m.p2];
          const r = m.result;
          const has = !!r;
          const winnerName = has ? appState.players[r.winnerId].name : '';
          const loserId = has ? (r.winnerId===p1.id ? p2.id : p1.id) : null;
          const loserName = has ? appState.players[loserId].name : '';
          const card = el(`
            <div class="card match">
              <div class="row wrap">
                <div class="players">
                  <div class="p"><span class="name">${p1.name}</span> <span class="hcp">(${p1.hcp})</span></div>
                  <div class="p"><span class="name">${p2.name}</span> <span class="hcp">(${p2.hcp})</span></div>
                </div>
                <div class="row" style="gap:6px">
                  ${ has ? `<div class="result"><span class="win">${winnerName}</span><span class="kicker">won</span><span class="badge">${r.margin}</span></div>` : `<span class="badge">No result</span>` }
                </div>
              </div>
              <div class="row" style="justify-content:flex-end; gap:8px">
                ${ has ? `<button class="btn ghost small" data-mid="${m.id}" data-act="clear">Clear</button>` : '' }
                <button class="btn small" data-mid="${m.id}" data-act="record">${ has ? 'Edit' : 'Record Result' }</button>
              </div>
            </div>`);
          grid.appendChild(card);
        }
      }
      container.querySelectorAll('button[data-act]')
        .forEach(btn=> btn.addEventListener('click', onMatchButton));
    }

    function computeStandings(){
      const stats = {};
      for(const p of Object.values(appState.players)){
        stats[p.id] = { id:p.id, name:p.name, hcp:p.hcp, group:p.group, played:0, wins:0, losses:0, diff:0 };
      }
      for(const m of Object.values(appState.matches)){
        if(!m.result) continue;
        const w = m.result.winnerId;
        const p1 = m.p1; const p2 = m.p2;
        const l = (w===p1? p2 : p1);
        const d = marginToDiff(m.result.margin);
        stats[w].wins++; stats[w].played++; stats[w].diff += d;
        stats[l].losses++; stats[l].played++; stats[l].diff -= d;
      }
      const grouped = { A:[],B:[],C:[],D:[] };
      for(const s of Object.values(stats)) grouped[s.group].push(s);
      for(const g of ['A','B','C','D']){
        grouped[g].sort((a,b)=> (b.wins-a.wins) || (b.diff-a.diff) || a.name.localeCompare(b.name));
      }
      return grouped;
    }

    function renderStandings(){
      const container = document.getElementById('standingsContainer');
      const grouped = computeStandings();
      container.innerHTML = '';
      for(const g of ['A','B','C','D']){
        const block = el(`<div class="card"><h2 style="margin-top:0">Group ${g}</h2>
          <table class="table">
            <thead><tr><th>Player</th><th class="stat">W</th><th class="stat">L</th><th class="stat">Diff</th><th class="stat">Pl</th></tr></thead>
            <tbody id="tbody_${g}"></tbody>
          </table>
          <div class="kicker">Top 2 advance from each group.</div>
        </div>`);
        container.appendChild(block);
        const body = block.querySelector(`#tbody_${g}`);
        grouped[g].forEach((s,idx)=>{
          const tr = el(`<tr class="${idx<2?'qual':''}"><td>${s.name} <span class="hcp">(${s.hcp})</span></td><td class="stat">${s.wins}</td><td class="stat">${s.losses}</td><td class="stat">${s.diff}</td><td class="stat">${s.played}</td></tr>`);
          body.appendChild(tr);
        });
      }
    }

    // ====== INTERACTION ======
    function onMatchButton(e){
      const mid = e.currentTarget.getAttribute('data-mid');
      const act = e.currentTarget.getAttribute('data-act');
      if(act==='record') openDialog(mid);
      if(act==='clear') clearResult(mid);
    }

    function openDialog(matchId){
      selectedMatchId = matchId;
      const m = appState.matches[matchId];
      const p1 = appState.players[m.p1];
      const p2 = appState.players[m.p2];
      document.getElementById('modalMatchLabel').innerText = `${p1.name} vs ${p2.name}`;
      const wSel = document.getElementById('winnerSelect');
      wSel.innerHTML = '';
      wSel.appendChild(el(`<option value="${p1.id}">${p1.name}</option>`));
      wSel.appendChild(el(`<option value="${p2.id}">${p2.name}</option>`));
      const margins = ['1 up','2 & 1','3 & 2','4 & 3','5 & 4','6 & 5','7 & 6','8 & 7','9 & 8'];
      const mSel = document.getElementById('marginSelect');
      mSel.innerHTML = '';
      margins.forEach(x=> mSel.appendChild(el(`<option>${x}</option>`)));
      if(m.result){
        wSel.value = m.result.winnerId;
        mSel.value = m.result.margin;
      }
      document.getElementById('resultDialog').showModal();
    }

    function closeDialog(){
      document.getElementById('resultDialog').close();
      selectedMatchId = null;
    }

    async function saveResult(){
      if(!selectedMatchId) return;
      const m = appState.matches[selectedMatchId];
      const winnerId = document.getElementById('winnerSelect').value;
      const margin = document.getElementById('marginSelect').value;
      const result = { winnerId, margin, ts: Date.now(), by: clientId };
      await api(`${ROOT_PATH}/matches/${m.id}/result`, { method:'PATCH', body: result });
      closeDialog();
    }

    async function clearResult(matchId){
      if(!confirm('Clear the recorded result for this match?')) return;
      await apiDelete(`${ROOT_PATH}/matches/${matchId}/result`);
    }

    function switchView(view){
      const m = document.getElementById('viewMatches');
      const s = document.getElementById('viewStandings');
      const tm = document.getElementById('tabMatches');
      const ts = document.getElementById('tabStandings');
      if(view==='matches'){ m.style.display='block'; s.style.display='none'; tm.classList.add('active'); ts.classList.remove('active'); }
      else { s.style.display='block'; m.style.display='none'; ts.classList.add('active'); tm.classList.remove('active'); renderStandings(); }
    }

    function showInitNotice(text){
      const n = document.getElementById('initNotice'); n.style.display='block'; n.innerText = text;
      setTimeout(()=>{ n.style.display='none'; }, 4000);
    }

    async function exportData(){
      const data = await api(`${ROOT_PATH}`);
      const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'tournament-export.json';
      a.click();
      URL.revokeObjectURL(a.href);
    }

    async function resetAll(){
      if(!confirm('Wipe ALL tournament data and re-seed?')) return;
      await apiDelete(`${ROOT_PATH}`);
      await ensureSeeded();
      await loadAll();
    }

    // ====== BOOT ======
    async function loadAll(){
      const data = await api(`${ROOT_PATH}`);
      if(data){ appState = data; }
      renderMatches();
      if(document.getElementById('viewStandings').style.display!=='none') renderStandings();
    }

    (async function init(){
      // Show reset button in admin mode (add #admin to URL)
      const isAdmin = location.hash.includes('admin');
      document.getElementById('resetBtn').style.display = isAdmin ? 'inline-flex' : 'none';

      document.getElementById('saveResultBtn').addEventListener('click', saveResult);
      document.getElementById('exportBtn').addEventListener('click', exportData);
      document.getElementById('resetBtn').addEventListener('click', resetAll);

      await ensureSeeded();
      await loadAll();

      // live updates via REST streaming (SSE)
      onStream(`${ROOT_PATH}`, (evt)=>{
        // evt = { path, data }
        if(evt && typeof evt.path === 'string'){
          if(evt.path === '/' && evt.data){ appState = evt.data; }
          else {
            // shallow patch
            const pathParts = evt.path.split('/').filter(Boolean);
            let node = appState;
            for(let i=0;i<pathParts.length-1;i++){
              const k = pathParts[i];
              if(!(k in node)) node[k] = {};
              node = node[k];
            }
            const last = pathParts[pathParts.length-1];
            node[last] = evt.data;
          }
          renderMatches();
          if(document.getElementById('viewStandings').style.display!=='none') renderStandings();
        }
      });
    })();
  </script>
</body>
</html>
